{% extends 'base.html' %}
{% load static %}
{% block title %}
  Blog Details
{% endblock %}

{% block content %}
  <section class="blog-posts grid-system">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <div class="all-blog-posts">
            <div class="row">
              {% if messages %}
                <div class="col-lg-12">
                  {% include 'message.html' %}
                </div>
              {% endif %}

              <!-- Blog Post -->
              <div class="col-lg-12">
                <div class="blog-post">
                  <div class="blog-thumb">
                    <img src="{{ blog.banner.url }}" alt="Blog Banner" />
                  </div>
                  <div class="down-content">
                    <span>{{ blog.category.title }}</span>
                    <a href="javascript:void(0);"><h4>{{ blog.title }}</h4></a>
                    <ul class="post-info">
                      <li>
                        <a href="javascript:void(0);">{{ blog.user.username }}</a>
                      </li>
                      <li>
                        <a href="javascript:void(0);">{{ blog.created_date }}</a>
                      </li>
                      <li>
                        <a href="javascript:void(0);">{{ blog.blog_comments.all.count }} Comments</a>
                      </li>
                    </ul>
                    <p>{{ blog.description|safe }}</p>
                  </div>
                </div>
              </div>

              <!-- Comments Section -->
              <div class="col-lg-12">
                <div class="sidebar-item comments">
                  <div class="sidebar-heading">
                    <h2>{{ blog.blog_comments.count }} Comments</h2>
                  </div>
                  <div class="content">
                    <ul class="d-flex flex-column">
                      {% for comment_data in comments_with_sentiment %}
                        <li>
                          <div class="author-thumb">
                            <img src="{{ comment_data.comment.user.get_profile_picture }}" alt="User Picture" />
                          </div>
                          <div class="right-content">
                            <h4>
                              {{ comment_data.comment.user.username }}
                              <span>{{ comment_data.comment.created_date }}</span>
                            </h4>
                            <p>{{ comment_data.comment.text }}</p>

                            <!-- Sentiment Styling -->
                            <p class="sentiment">
                              {% if request.user == blog.user %}
                                <strong>Sentiment:</strong>
                                <span class="{% if comment_data.sentiment == 'POSITIVE' %}
                                    
                                  
                                  text-success


                                  {% elif comment_data.sentiment == 'NEGATIVE' %}
                                    
                                  
                                  text-danger


                                  {% else %}
                                    
                                  
                                  text-secondary


                                  {% endif %}">
                                  {{ comment_data.sentiment }}
                                </span>
                              {% endif %}
                            </p>

                            <!-- Reply Form -->
                            <form class="submit-reply my-2" id="reply-form" action="{% url 'add_reply' blog.id comment_data.comment.id %}" method="POST">
                              {% csrf_token %}
                              <div class="row">
                                <div class="col-lg-12">
                                  <fieldset>
                                    <textarea name="text" rows="2" cols="100" id="reply-message" placeholder="Type your reply" required></textarea>
                                  </fieldset>
                                </div>
                                <div class="col-lg-12">
                                  <fieldset>
                                    {% if request.user.is_authenticated %}
                                      <button type="submit" class="main-button reply-button">Reply</button>
                                    {% else %}
                                      <a href="{% url 'login' %}" class="main-button reply-button">Login to reply</a>
                                    {% endif %}
                                  </fieldset>
                                </div>
                              </div>
                            </form>
                          </div>
                        </li>

                        <!-- Replies to Comments -->
                        {% for reply in comment_data.comment.comment_replies.all %}
                          <li class="replied">
                            <div class="author-thumb">
                              <img src="{{ reply.user.get_profile_picture }}" alt="" />
                            </div>
                            <div class="right-content">
                              <h4>
                                {{ reply.user.username }}
                                <span>{{ reply.created_date }}</span>
                              </h4>
                              <p>{{ reply.text }}</p>
                            </div>
                          </li>
                        {% endfor %}
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Add a Comment -->
              <div class="col-lg-12">
                <div class="sidebar-item submit-comment">
                  <div class="sidebar-heading">
                    <h2>Your Comment</h2>
                  </div>
                  <div class="content">
                    <form id="comment-form" action="{% url 'blog_details' blog.slug %}" method="POST">
                      {% csrf_token %}
                      <div class="row">
                        <div class="col-lg-12">
                          <fieldset>
                            <textarea name="text" rows="6" id="comment-message" placeholder="Type your comment" required></textarea>
                          </fieldset>
                        </div>
                        <div class="col-lg-12">
                          <fieldset>
                            {% if request.user.is_authenticated %}
                              <button type="submit" class="main-button">Submit</button>
                            {% else %}
                              <a href="{% url 'login' %}" class="main-button">Login to comment</a>
                            {% endif %}
                          </fieldset>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <div class="sidebar">
            <div class="row">
              <!-- Search -->
              <div class="col-lg-12">
                <div class="sidebar-item search">
                  <form id="search_form" name="gs" method="GET" action="#">
                    <input type="text" name="q" class="searchText" placeholder="type to search..." autocomplete="on" />
                  </form>
                </div>
              </div>

              <!-- Related Posts -->
              <div class="col-lg-12">
                <div class="sidebar-item recent-posts">
                  <div class="sidebar-heading">
                    <h2>Related Posts</h2>
                  </div>
                  <div class="content">
                    <ul>
                      {% for blog in related_blogs %}
                        <li>
                          <a href="{% url 'blog_details' blog.slug %}">
                            <h5>{{ blog.title }}</h5>
                            <span>{{ blog.created_date }}</span>
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Categories -->
              <div class="col-lg-12">
                <div class="sidebar-item categories">
                  <div class="sidebar-heading">
                    <h2>Categories</h2>
                  </div>
                  <div class="content">
                    <ul>
                      {% for category in categories %}
                        <li>
                          <a href="{% url 'category_blogs' category.slug %}">- {{ category.title }}</a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script src="{% static 'js/like_blog.js' %}"></script>
{% endblock %}
